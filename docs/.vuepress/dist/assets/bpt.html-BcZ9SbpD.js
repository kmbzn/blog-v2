import{_ as s,c as a,a as p,o as t}from"./app-roWsHDGr.js";const e={};function o(c,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c"><pre><code class="language-c"><span class="line"><span class="token comment">// bptree1/src/bpt.c</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bpt.h&quot;</span></span></span>
<span class="line"></span>
<span class="line">H_P <span class="token operator">*</span> hp<span class="token punctuation">;</span></span>
<span class="line">page <span class="token operator">*</span> rt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">// --- File I/O &amp; Page Management ---</span></span>
<span class="line"></span>
<span class="line">H_P <span class="token operator">*</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> off<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    H_P <span class="token operator">*</span> newhp <span class="token operator">=</span> <span class="token punctuation">(</span>H_P<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> newhp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>newhp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> newhp<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">page <span class="token operator">*</span> <span class="token function">load_page</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> off<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> load <span class="token operator">=</span> <span class="token punctuation">(</span>page<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> load<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> load<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">open_table</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> pathname<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 파일 생성 시도 (존재하지 않을 경우)</span></span>
<span class="line">    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL <span class="token operator">|</span> O_SYNC<span class="token punctuation">,</span> <span class="token number">0775</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hp <span class="token operator">=</span> <span class="token punctuation">(</span>H_P <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        hp<span class="token operator">-&gt;</span>fpo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        hp<span class="token operator">-&gt;</span>num_of_pages <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        hp<span class="token operator">-&gt;</span>rpo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 기존 파일 열기</span></span>
<span class="line">    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>rpo <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            rt <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 새 페이지 할당 (Free List 재사용 또는 파일 확장)</span></span>
<span class="line"><span class="token class-name">off_t</span> <span class="token function">new_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">off_t</span> newp<span class="token punctuation">;</span></span>
<span class="line">    page <span class="token operator">*</span> np<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. Free Page 재사용</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>fpo <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        newp <span class="token operator">=</span> hp<span class="token operator">-&gt;</span>fpo<span class="token punctuation">;</span></span>
<span class="line">        np <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>newp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        hp<span class="token operator">-&gt;</span>fpo <span class="token operator">=</span> np<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">;</span> <span class="token comment">// Free List Head 갱신</span></span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">freetouse</span><span class="token punctuation">(</span>newp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 페이지 내용 초기화</span></span>
<span class="line">        <span class="token keyword">return</span> newp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 파일 끝(EOF) 확장</span></span>
<span class="line">    newp <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reset</span><span class="token punctuation">(</span>newp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 페이지 초기화</span></span>
<span class="line">    hp<span class="token operator">-&gt;</span>num_of_pages<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newp<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 페이지 초기화 (0으로 채움)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> off<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page <span class="token operator">*</span> reset <span class="token operator">=</span> <span class="token punctuation">(</span>page<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> reset<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>reset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 페이지 초기화 (Free List에서 꺼낼 때)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">freetouse</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> fpo<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page <span class="token operator">*</span> reset <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>fpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    reset<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    reset<span class="token operator">-&gt;</span>is_leaf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    reset<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    reset<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> reset<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> fpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>reset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 페이지 반납 (Free List에 추가)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">usetofree</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> wbf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page <span class="token operator">*</span> utf <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>wbf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    utf<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> hp<span class="token operator">-&gt;</span>fpo<span class="token punctuation">;</span> <span class="token comment">// 기존 Head를 가리킴</span></span>
<span class="line">    utf<span class="token operator">-&gt;</span>is_leaf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    utf<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    utf<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> utf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> wbf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>utf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    hp<span class="token operator">-&gt;</span>fpo <span class="token operator">=</span> wbf<span class="token punctuation">;</span> <span class="token comment">// Head 갱신</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">cut</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span> <span class="token keyword">return</span> length <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 새 DB 파일 시작 (Root 생성)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">start_new_file</span><span class="token punctuation">(</span>record rec<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">off_t</span> ro <span class="token operator">=</span> <span class="token function">new_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hp<span class="token operator">-&gt;</span>rpo <span class="token operator">=</span> ro<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    rt <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>ro<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    rt<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    rt<span class="token operator">-&gt;</span>is_leaf <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    rt<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    rt<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rec<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    rt <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// --- Find Operation ---</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Key가 위치한 Leaf Page 탐색</span></span>
<span class="line"><span class="token class-name">off_t</span> <span class="token function">find_leaf</span><span class="token punctuation">(</span><span class="token class-name">int64_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>rpo <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">off_t</span> current_offset <span class="token operator">=</span> hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>current_offset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>current_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> current_offset<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&amp;&amp;</span> key <span class="token operator">&gt;=</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                i<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">// 왼쪽 포인터 결정 (one more page vs b_f[i])</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> current_offset <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">else</span> current_offset <span class="token operator">=</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Find API</span></span>
<span class="line"><span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">db_find</span><span class="token punctuation">(</span><span class="token class-name">int64_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">off_t</span> leaf_offset <span class="token operator">=</span> <span class="token function">find_leaf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf_offset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">char</span><span class="token operator">*</span> ret_val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_val <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">            <span class="token function">memcpy</span><span class="token punctuation">(</span>ret_val<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> ret_val<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// --- Insert Operation ---</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Leaf Page에 단순 삽입 (공간 있음)</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">insert_into_leaf</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> leaf_offset<span class="token punctuation">,</span> record rec<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&amp;&amp;</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&lt;</span> rec<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        i<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> j <span class="token operator">&gt;</span> i<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rec<span class="token punctuation">;</span></span>
<span class="line">    p<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Leaf Page 분할 후 삽입</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">insert_into_leaf_after_splitting</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> leaf_offset<span class="token punctuation">,</span> record rec<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">off_t</span> new_leaf_offset <span class="token operator">=</span> <span class="token function">new_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> old_leaf <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> new_leaf <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>new_leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    new_leaf<span class="token operator">-&gt;</span>is_leaf <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 1. 임시 버퍼에 정렬하여 삽입</span></span>
<span class="line">    record temp_records<span class="token punctuation">[</span>LEAF_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> LEAF_MAX <span class="token operator">&amp;&amp;</span> old_leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&lt;</span> rec<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        temp_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> old_leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        i<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    temp_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rec<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> LEAF_MAX<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        temp_records<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> old_leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2. 분할 (Split)</span></span>
<span class="line">    <span class="token keyword">int</span> split <span class="token operator">=</span> <span class="token function">cut</span><span class="token punctuation">(</span>LEAF_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. Old Page 갱신</span></span>
<span class="line">    old_leaf<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> split<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> split<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        old_leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> temp_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. New Page 갱신</span></span>
<span class="line">    new_leaf<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> <span class="token punctuation">(</span>LEAF_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> split<span class="token punctuation">;</span></span>
<span class="line">    j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> split<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> LEAF_MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        new_leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. Link 연결 (Old -&gt; New)</span></span>
<span class="line">    new_leaf<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> old_leaf<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">    old_leaf<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> new_leaf_offset<span class="token punctuation">;</span></span>
<span class="line">    new_leaf<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> old_leaf<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> old_leaf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> new_leaf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> new_leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>old_leaf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>new_leaf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 6. 부모에 New Page Key 삽입</span></span>
<span class="line">    new_leaf <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>new_leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">int64_t</span> new_key <span class="token operator">=</span> new_leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>new_leaf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">insert_into_parent</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">,</span> new_key<span class="token punctuation">,</span> new_leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Internal Page 단순 삽입</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">insert_into_internal</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> parent_po<span class="token punctuation">,</span> <span class="token keyword">int</span> left_index<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">,</span> <span class="token class-name">off_t</span> right_po<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> parent<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> left_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>left_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span></span>
<span class="line">    parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>left_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">=</span> right_po<span class="token punctuation">;</span></span>
<span class="line">    parent<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> parent_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Internal Page 분할 후 삽입</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">insert_into_internal_after_splitting</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> old_page_po<span class="token punctuation">,</span> <span class="token keyword">int</span> left_index<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">,</span> <span class="token class-name">off_t</span> right_po<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    I_R temp_entries<span class="token punctuation">[</span>INTERNAL_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> old_page <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>old_page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">off_t</span> temp_first_po <span class="token operator">=</span> old_page<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. 임시 버퍼에 정렬 및 삽입</span></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> left_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> temp_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> old_page<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    temp_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span></span>
<span class="line">    temp_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">=</span> right_po<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> INTERNAL_MAX<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> temp_entries<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> old_page<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2. 분할 및 K_prime(부모로 올릴 키) 선정</span></span>
<span class="line">    <span class="token keyword">int</span> split_index <span class="token operator">=</span> <span class="token function">cut</span><span class="token punctuation">(</span>INTERNAL_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">int64_t</span> k_prime <span class="token operator">=</span> temp_entries<span class="token punctuation">[</span>split_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3. Old Page 갱신</span></span>
<span class="line">    old_page<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> split_index<span class="token punctuation">;</span></span>
<span class="line">    old_page<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> temp_first_po<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> split_index<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> old_page<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> temp_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 4. New Page 생성 및 갱신</span></span>
<span class="line">    <span class="token class-name">off_t</span> new_page_po <span class="token operator">=</span> <span class="token function">new_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> new_page <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>new_page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    new_page<span class="token operator">-&gt;</span>is_leaf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    new_page<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> temp_entries<span class="token punctuation">[</span>split_index<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">;</span> <span class="token comment">// K_prime의 오른쪽 자식이 New Page의 첫 포인터</span></span>
<span class="line">    new_page<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> <span class="token punctuation">(</span>INTERNAL_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>split_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> split_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> INTERNAL_MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> new_page<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 5. 자식들의 부모 포인터 갱신</span></span>
<span class="line">    page<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>new_page<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    child<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> new_page_po<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> new_page<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> new_page<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        child <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>new_page<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        child<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> new_page_po<span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> new_page<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    new_page<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> old_page<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> old_page<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> old_page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> new_page<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> new_page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>old_page<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>new_page<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">insert_into_parent</span><span class="token punctuation">(</span>old_page_po<span class="token punctuation">,</span> k_prime<span class="token punctuation">,</span> new_page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 부모에 Key 삽입 (재귀)</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">insert_into_parent</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> left_po<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">,</span> <span class="token class-name">off_t</span> right_po<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> left <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>left_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">off_t</span> parent_po <span class="token operator">=</span> left<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Case 1: 부모 없음 (새 Root 생성)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent_po <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">insert_into_new_root</span><span class="token punctuation">(</span>left_po<span class="token punctuation">,</span> key<span class="token punctuation">,</span> right_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Case 2: 부모 존재</span></span>
<span class="line">    <span class="token keyword">int</span> left_index <span class="token operator">=</span> <span class="token function">get_left_index</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">,</span> left_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&lt;</span> INTERNAL_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">insert_into_internal</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">,</span> left_index<span class="token punctuation">,</span> key<span class="token punctuation">,</span> right_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">insert_into_internal_after_splitting</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">,</span> left_index<span class="token punctuation">,</span> key<span class="token punctuation">,</span> right_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">insert_into_new_root</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> left_po<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">,</span> <span class="token class-name">off_t</span> right_po<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">off_t</span> root_po <span class="token operator">=</span> <span class="token function">new_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> root <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>root_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> left <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>left_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> right <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>right_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    root<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    root<span class="token operator">-&gt;</span>is_leaf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    root<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    root<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> left_po<span class="token punctuation">;</span></span>
<span class="line">    root<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span></span>
<span class="line">    root<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">=</span> right_po<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    left<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> root_po<span class="token punctuation">;</span></span>
<span class="line">    right<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> root_po<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> root_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> left<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> left_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> right_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    hp<span class="token operator">-&gt;</span>rpo <span class="token operator">=</span> root_po<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Insert API</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">db_insert</span><span class="token punctuation">(</span><span class="token class-name">int64_t</span> key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span><span class="token operator">*</span> find_result <span class="token operator">=</span> <span class="token function">db_find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>find_result <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>find_result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 중복 키</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    record new_record<span class="token punctuation">;</span></span>
<span class="line">    new_record<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">strncpy</span><span class="token punctuation">(</span>new_record<span class="token punctuation">.</span>value<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>rpo <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">start_new_file</span><span class="token punctuation">(</span>new_record<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">off_t</span> leaf_offset <span class="token operator">=</span> <span class="token function">find_leaf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> leaf_page <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf_page<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&lt;</span> LEAF_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>leaf_page<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">insert_into_leaf</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">,</span> new_record<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>leaf_page<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">insert_into_leaf_after_splitting</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">,</span> new_record<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// --- Delete Operation ---</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 왼쪽 형제 인덱스 찾기</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">get_neighbor_index</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> page_offset<span class="token punctuation">,</span> <span class="token class-name">off_t</span> parent_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>parent_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">-&gt;</span>next_offset <span class="token operator">==</span> page_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 왼쪽 형제 없음 (자신이 첫째)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">==</span> page_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 왼쪽 형제가 one-more-page</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parent<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">==</span> page_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">get_left_index</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> parent_po<span class="token punctuation">,</span> <span class="token class-name">off_t</span> left_po<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">-&gt;</span>next_offset <span class="token operator">==</span> left_po<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parent<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">==</span> left_po<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> i<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 물리적 레코드 삭제 (Leaf)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">remove_record_from_leaf</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> leaf_po<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> leaf <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>leaf_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> key<span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> leaf<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    leaf<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> leaf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> leaf_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 물리적 키 삭제 (Internal)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">remove_entry_from_internal</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> internal_po<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>internal_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> key<span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    p<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> internal_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Root 조정</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">adjust_root</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> root_po<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> root <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>root_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Root가 비었고 Internal인 경우 -&gt; 자식을 새 Root로 승격</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>root<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        hp<span class="token operator">-&gt;</span>rpo <span class="token operator">=</span> root<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">        page<span class="token operator">*</span> new_root <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        new_root<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> new_root<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>new_root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">usetofree</span><span class="token punctuation">(</span>root_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// Root가 비었고 Leaf인 경우 -&gt; 트리 삭제</span></span>
<span class="line">    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> root<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        hp<span class="token operator">-&gt;</span>rpo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> hp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>H_P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        hp <span class="token operator">=</span> <span class="token function">load_header</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">usetofree</span><span class="token punctuation">(</span>root_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 재분배 (Redistribute)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">redistribute_nodes</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> neighbor_po<span class="token punctuation">,</span> <span class="token class-name">off_t</span> page_po<span class="token punctuation">,</span> <span class="token keyword">int</span> neighbor_index<span class="token punctuation">,</span> <span class="token keyword">int</span> k_prime_index<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> k_prime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> neighbor <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>neighbor_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Case 1: Neighbor가 왼쪽 (Borrow from Left)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>neighbor_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> k_prime<span class="token punctuation">;</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            page<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            child<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> page_po<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>k_prime_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>k_prime_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// Case 2: Neighbor가 오른쪽 (Borrow from Right)</span></span>
<span class="line">    <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> k_prime<span class="token punctuation">;</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            page<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>neighbor<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            child<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> page_po<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> neighbor<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>k_prime_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">            neighbor<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> neighbor<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span> <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>k_prime_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> neighbor<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> neighbor<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> neighbor<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    p<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> neighbor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> neighbor_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 병합 (Coalesce)</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">coalesce_nodes</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> neighbor_po<span class="token punctuation">,</span> <span class="token class-name">off_t</span> page_po<span class="token punctuation">,</span> <span class="token keyword">int</span> neighbor_index<span class="token punctuation">,</span> <span class="token keyword">int</span> k_prime_index<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> k_prime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    page<span class="token operator">*</span> neighbor <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>neighbor_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Swap (항상 p를 neighbor로 합치기 위해)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>neighbor_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        page<span class="token operator">*</span> tmp <span class="token operator">=</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> neighbor<span class="token punctuation">;</span> neighbor <span class="token operator">=</span> tmp<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">off_t</span> tmp_off <span class="token operator">=</span> page_po<span class="token punctuation">;</span> page_po <span class="token operator">=</span> neighbor_po<span class="token punctuation">;</span> neighbor_po <span class="token operator">=</span> tmp_off<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 1. 내용 병합</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> k_prime<span class="token punctuation">;</span></span>
<span class="line">        neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">        neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            neighbor<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 자식들의 부모 변경</span></span>
<span class="line">        page<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        child<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> neighbor_po<span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            child <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            child<span class="token operator">-&gt;</span>parent_page_offset <span class="token operator">=</span> neighbor_po<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">free</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            neighbor<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            neighbor<span class="token operator">-&gt;</span>num_of_keys<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        neighbor<span class="token operator">-&gt;</span>next_offset <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_offset<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> neighbor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> neighbor_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">usetofree</span><span class="token punctuation">(</span>page_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. 부모에서 Key 삭제 (재귀)</span></span>
<span class="line">    <span class="token function">delete_entry</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">,</span> k_prime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 엔트리 삭제 (재귀 호출의 핵심)</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">delete_entry</span><span class="token punctuation">(</span><span class="token class-name">off_t</span> page_offset<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. 물리적 삭제</span></span>
<span class="line">    page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>page_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>is_leaf<span class="token punctuation">)</span> <span class="token function">remove_record_from_leaf</span><span class="token punctuation">(</span>page_offset<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span> <span class="token function">remove_entry_from_internal</span><span class="token punctuation">(</span>page_offset<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2. Root 체크</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>page_offset <span class="token operator">==</span> hp<span class="token operator">-&gt;</span>rpo<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">adjust_root</span><span class="token punctuation">(</span>page_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3. Underflow 체크</span></span>
<span class="line">    <span class="token keyword">int</span> min_keys <span class="token operator">=</span> p<span class="token operator">-&gt;</span>is_leaf <span class="token operator">?</span> <span class="token function">cut</span><span class="token punctuation">(</span>LEAF_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token function">cut</span><span class="token punctuation">(</span>INTERNAL_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>page_offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Refresh</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&gt;=</span> min_keys<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 4. Underflow 발생: Neighbor &amp; K_prime 찾기</span></span>
<span class="line">    <span class="token class-name">off_t</span> parent_po <span class="token operator">=</span> p<span class="token operator">-&gt;</span>parent_page_offset<span class="token punctuation">;</span></span>
<span class="line">    page<span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>parent_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> neighbor_index <span class="token operator">=</span> <span class="token function">get_neighbor_index</span><span class="token punctuation">(</span>page_offset<span class="token punctuation">,</span> parent_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> k_prime_index <span class="token operator">=</span> <span class="token punctuation">(</span>neighbor_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> neighbor_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">int64_t</span> k_prime <span class="token operator">=</span> parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>k_prime_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">off_t</span> neighbor_po <span class="token operator">=</span> <span class="token punctuation">(</span>neighbor_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset <span class="token operator">:</span> </span>
<span class="line">                        <span class="token punctuation">(</span>neighbor_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> parent<span class="token operator">-&gt;</span>next_offset <span class="token operator">:</span> </span>
<span class="line">                        parent<span class="token operator">-&gt;</span>b_f<span class="token punctuation">[</span>neighbor_index<span class="token punctuation">]</span><span class="token punctuation">.</span>p_offset<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    page<span class="token operator">*</span> neighbor <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>neighbor_po<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 5. 재분배 또는 병합</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>neighbor<span class="token operator">-&gt;</span>num_of_keys <span class="token operator">&gt;</span> min_keys<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">redistribute_nodes</span><span class="token punctuation">(</span>neighbor_po<span class="token punctuation">,</span> page_offset<span class="token punctuation">,</span> neighbor_index<span class="token punctuation">,</span> k_prime_index<span class="token punctuation">,</span> k_prime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">coalesce_nodes</span><span class="token punctuation">(</span>neighbor_po<span class="token punctuation">,</span> page_offset<span class="token punctuation">,</span> neighbor_index<span class="token punctuation">,</span> k_prime_index<span class="token punctuation">,</span> k_prime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">free</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Delete API</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">db_delete</span><span class="token punctuation">(</span><span class="token class-name">int64_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">off_t</span> leaf_offset <span class="token operator">=</span> <span class="token function">find_leaf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf_offset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    page<span class="token operator">*</span> leaf <span class="token operator">=</span> <span class="token function">load_page</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    bool found <span class="token operator">=</span> false<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> leaf<span class="token operator">-&gt;</span>num_of_keys<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf<span class="token operator">-&gt;</span>records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            found <span class="token operator">=</span> true<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">free</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">delete_entry</span><span class="token punctuation">(</span>leaf_offset<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/db/bpt.html","title":"","lang":"ko-KR","frontmatter":{},"git":{"updatedTime":1763626622000,"contributors":[{"name":"kmbzn","username":"kmbzn","email":"kmbzn24@gmail.com","commits":2,"url":"https://github.com/kmbzn"}],"changelog":[{"hash":"e1588204c171cbae93dfd80169721931ca36e2ed","time":1763626622000,"email":"kmbzn24@gmail.com","author":"kmbzn","message":"c"},{"hash":"db59f13412c70dbd49dd7fa6dd23398d0d3044bc","time":1763626450000,"email":"kmbzn24@gmail.com","author":"kmbzn","message":"bpt code update"}]},"filePathRelative":"db/bpt.md"}');export{i as comp,u as data};
