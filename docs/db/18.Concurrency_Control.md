# 18. Concurrency Control

## Overview
- ìŠ¤ì¼€ì¤„ 1: $T_1$ ë‹¤ìŒì— $T_2$ê°€ ì˜¤ëŠ” ì§ë ¬ ìŠ¤ì¼€ì¤„
- ìŠ¤ì¼€ì¤„ 3: ìŠ¤ì¼€ì¤„ 1ê³¼ ë™ë“±í•œ ë™ì‹œì„± ìŠ¤ì¼€ì¤„
- ìŠ¤ì¼€ì¤„ 2: $T_2$ ë‹¤ìŒì— $T_1$ì´ ì˜¤ëŠ” ì§ë ¬ ìŠ¤ì¼€ì¤„
- Conflict: ì¶©ëŒ ë°œìƒ
- Concurrency Control: ì¶©ëŒí•˜ëŠ” ëª…ë ¹ ê°„ì˜ ì‹¤í–‰ ìˆœì„œë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë©´ì„œ, ë™ì‹œì„± ë ˆë²¨ì„ ê°€ëŠ¥í•œ í•œ ë†’ê²Œ ë§Œë“œëŠ” ìŠ¤ì¼€ì¤„ ìƒì„±

## Lock-based Protocols
- Lock: ë°ì´í„° ì•„ì´í…œì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜
- ë°ì´í„° ì•„ì´í…œì€ ë‘ ê°€ì§€ ëª¨ë“œë¡œ ì ê¸¸ ìˆ˜ ìˆìŒ
  1. eXclusive (X) mode: ë°ì´í„° ì•„ì´í…œì„ ì½ê³  ì“¸ ìˆ˜ ìˆìŒ.
  - **lock-X** ë° **unlock** ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ X-lockì„ ìš”ì²­í•˜ê³  í•´ì œ
  2. Shared (S) mode: ë°ì´í„° ì•„ì´í…œì„ ì½ì„ ìˆ˜ë§Œ ìˆìŒ.
  - **lock-S** ë° **unlock** ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ S-lockì„ ìš”ì²­í•˜ê³  í•´ì œ
- ëª¨ë“  transactionì€ ë°ì´í„° ì•„ì´í…œ Qì— ëŒ€í•´ ìˆ˜í–‰í•  Operation ìœ í˜•ì— ë”°ë¼ ì ì ˆí•œ ëª¨ë“œë¡œ Lockì„ ìš”ì²­
  - Lock ìš”ì²­ì€ Concurrency-Control Managerë¡œ ì „ë‹¬
  - Lock ìš”ì²­ì´ ìŠ¹ì¸ëœ í›„ì—ë§Œ transactionì´ ì§„í–‰ ê°€ëŠ¥
- ìš”ì²­ëœ Lockì´ í•´ë‹¹ ì•„ì´í…œì— ëŒ€í•´ ë‹¤ë¥¸ transactionì´ ì´ë¯¸ ë³´ìœ í•˜ê³  ìˆëŠ” Lockê³¼ Compatibleí•˜ë©´ transactionì€ Lockì„ ë¶€ì—¬ë°›ì„ ìˆ˜ ìˆìŒ
- S-lock: ì„ì˜ì˜ ìˆ˜ì˜ transactionì´ ì•„ì´í…œì— ëŒ€í•´ ë³´ìœ  ê°€ëŠ¥
- X-lock: í•œ transactionì´ X-lockì„ ë³´ìœ í•˜ê³  ìˆë‹¤ë©´, ë‹¤ë¥¸ transactionì€ í•´ë‹¹ ì•„ì´í…œì— ëŒ€í•´ ì–´ë– í•œ Lockë„ ë³´ìœ í•  ìˆ˜ ì—†ìŒ

| | S | X |
| - | - | - |
| S | `true` | `false` |
| X | `false` | `true` |

> Lock Compatibility Matrix

## Schedule with Lock Grants
- ë‚˜ë¨¸ì§€ ì¥ì—ì„œëŠ” Grant ìƒëµ
- Lock ìš”ì²­ ë°”ë¡œ ë‹¤ìŒì— ì˜¤ëŠ” ë‹¤ìŒ ëª…ë ¹ ì§ì „ì— Grantê°€ ë°œìƒí•œë‹¤ê³  ê°€ì •
- ì´ ìŠ¤ì¼€ì¤„ì€ Serializableí•˜ì§€ ì•ŠìŒ
  - Lockì„ ë‹¨ìˆœíˆ íšë“/í•´ì œí•˜ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” Transaction isolation serializabilityì„ ë³´ì¥í•˜ì§€ ëª»í•¨

| $T_1$ | $T_2$ | concurrency-control manager |
| - | - | - |
| lock-X($B$) | | grant-X($B,~T_1$)
| read($B$)<br>$B:=B-50$<br>write($B$)<br>unlock($B$) | |
| | lock-S($A$) |
| | | grant-S($A,~T_2$)
| | read($A$)<br>unlock(A)<br>lock-S($B$) |
| | | grant-S($B,~T_2$)
| | read($B$)<br>unlock($B$)<br>display($A+B$) |
| lock-X($A$) | |
| | | grant-X($A,~T_1$)
| read($A$)<br>$A:=A+50$<br>write($A$)<br>unlock($A$)

## Locking Protocols
- Locking Protocol: ëª¨ë“  transactionì´ Lockì„ ìš”ì²­í•˜ê³  í•´ì œí•  ë•Œ ë”°ë¥´ëŠ” ê·œì¹™ì˜ ì§‘í•©
- ê°€ëŠ¥í•œ ìŠ¤ì¼€ì¤„ ì§‘í•©ì„ ì œí•œí•˜ì—¬ Serializabilityë¥¼ ê°•ì œ
- ì£¼ì–´ì§„ Locking Protocol í•˜ì—ì„œ,
  - ìŠ¤ì¼€ì¤„ SëŠ” í•´ë‹¹ Protocolì„ ë”°ë¥´ëŠ” transaction ì§‘í•©ì— ì˜í•´ ìƒì„±ë  ìˆ˜ ìˆë‹¤ë©´ í•´ë‹¹ Protocol í•˜ì—ì„œ Legal
  - Protocolì€ í•´ë‹¹ Protocol í•˜ì˜ ëª¨ë“  Legal ìŠ¤ì¼€ì¤„ì´ Serialiazableí•˜ë‹¤ë©´ Serializabilityë¥¼ ë³´ì¥

## Deadlock and Starvation
- ë¶€ë¶„ ìŠ¤ì¼€ì¤„ì„ ê³ ë ¤
  - $T_3$ì™€ $T_4$ ëª¨ë‘ ì§„í–‰í•  ìˆ˜ ì—†ìŒ
  - lock-S(B) ì‹¤í–‰ì€ $T_4$ê°€ $T_3$ê°€ Bì— ëŒ€í•œ X-lockì„ í•´ì œí•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê²Œ í•˜ê³ , `lock-X(A)` ì‹¤í–‰ì€ $T_3$ê°€ $T_4$ê°€ Aì— ëŒ€í•œ S-lockì„ í•´ì œí•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê²Œ í•¨
- ì´ëŸ¬í•œ ìƒí™©ì„ Deadlockì´ë¼ê³  í•¨
- Deadlockì„ ì²˜ë¦¬í•˜ë ¤ë©´ $T_3$ ë˜ëŠ” $T_4$ ì¤‘ í•˜ë‚˜ê°€ Rollbackë˜ì–´ì•¼ í•˜ê³  Lockì´ í•´ì œë˜ì–´ì•¼ í•¨
- Deadlockì˜ ì ì¬ì„±ì€ ëŒ€ë¶€ë¶„ì˜ Locking Protocolì— ì¡´ì¬í•˜ë©°, ì´ëŠ” í•„ìš”ì•…
- Starvation ë˜í•œ Concurrency Control Managerê°€ ì˜ëª» ì„¤ê³„ë˜ë©´ ë°œìƒ ê°€ëŠ¥
  - Case 1: í•œ transactionì´ ì•„ì´í…œì— ëŒ€í•œ X-lockì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ, ë‹¤ë¥¸ transactionë“¤ì˜ ì—°ì†ì ì¸ S-lock ìš”ì²­ì´ ìŠ¹ì¸ë˜ëŠ” ê²½ìš°
  - Case 2: ë™ì¼í•œ transactionì´ Deadlockìœ¼ë¡œ ì¸í•´ ë°˜ë³µì ìœ¼ë¡œ Rollbackë˜ëŠ” ê²½ìš°
- Concurrency Control ManagerëŠ” Starvationì„ ë°©ì§€í•˜ë„ë¡ ì„¤ê³„ë  ìˆ˜ ìˆìŒ

| $T_3$ | $T_4$
| - | -
| lock-X($B$)<br>read($B$)<br>$B:=B-50$
| | lock-S($A$)<br>read($A$)<br>lock-S($B$)
| lock-X($A$) |

## Two-Phase Locking (2PL) Protocol
- Conflict-Serializable ìŠ¤ì¼€ì¤„ì„ ë³´ì¥í•˜ëŠ” Protocol
- ê° transactionì€ Lock ìš”ì²­ê³¼ í•´ì œë¥¼ ë‘ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ì‹¤í–‰í•´ì•¼ í•¨
![alt text](image-10.png)
  - Phase 1: Growing Phase
    - Transactionì€ Lockì„ íšë“í•  ìˆ˜ ìˆìŒ
    - Transactionì€ Lockì„ í•´ì œí•  ìˆ˜ ì—†ìŒ
  - Phase 2: Shrinking Phase
    - Transactionì€ Lockì„ í•´ì œí•  ìˆ˜ ìˆìŒ
    - Transactionì€ Lockì„ íšë“í•  ìˆ˜ ì—†ìŒ
- ì´ Protocolì€ Serializabilityë¥¼ ë³´ì¥
  - Transactionë“¤ì€ Lock Point(ìµœì¢… Lockì„ íšë“í•œ ì‹œì ) ìˆœì„œë¡œ Serializeë  ìˆ˜ ìˆìŒì´ ì¦ëª… ê°€ëŠ¥
- Two-Phase Lockingì€ Serializabilityë¥¼ ìœ„í•œ í•„ìˆ˜ ì¡°ê±´ì€ ì•„ë‹˜
  - 2PLì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ì–»ì„ ìˆ˜ ìˆëŠ” Conflict Serializable ìŠ¤ì¼€ì¤„ì´ ìˆìŒ
- ê·¸ëŸ¬ë‚˜ Data ì ‘ê·¼ ìˆœì„œì™€ ê°™ì€ ì¶”ê°€ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°, Two-Phase Lockingì€ Conflict Serializabilityì— í•„ìš”
- ì¶”ê°€ ì •ë³´ê°€ ìˆë‹¤ë©´, 2PL ì´ì™¸ì˜ ë‹¤ë¥¸ Locking Protocolì„ ê³ ì•ˆí•  ìˆ˜ ìˆìŒ
- Two-Phase Lockingì€ Deadlockìœ¼ë¡œë¶€í„°ì˜ ììœ ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŒ
- Cascading Roll-backì´ ì—†ëŠ” Recoverabilityë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ ê¸°ë³¸ 2PLì— í™•ì¥ì´ í•„ìš”í•¨
  - Strict Two-Phase Locking: transactionì€ Commit ë˜ëŠ” Abortí•  ë•Œê¹Œì§€ ëª¨ë“  X-lockì„ ë³´ìœ í•´ì•¼ í•¨
    - Recoverabilityë¥¼ ë³´ì¥í•˜ê³  Cascading Roll-backì„ ë°©ì§€
  - Rigorous Two-Phase Locking: transactionì€ Commit ë˜ëŠ” Abortí•  ë•Œê¹Œì§€ ëª¨ë“  Lockì„ ë³´ìœ í•´ì•¼ í•¨
    - Transactionì€ Commit ìˆœì„œë¡œ Serializeë  ìˆ˜ ìˆìŒ
- Lock Conversions
  - $T_1$: read($a_1$), read($a_2$), $\dots$, read($a_n$), write($a_1$)
  - $T_2$: read($a_1$), read($a_2$), $\dots$, display($a_1+a_2$)
  - $T_1$ì€ $a_1$ì— ëŒ€í•œ X-lockì„ íšë“í•´ì•¼ í•¨
    - $T_1$ì´ $T_2$ë³´ë‹¤ ë¨¼ì € ì‹œì‘í•˜ë©´, $T_1$ê³¼ $T_2$ì˜ ëª¨ë“  ë™ì‹œ ì‹¤í–‰ì€ ì§ë ¬ ì‹¤í–‰ê³¼ ê°™ìŒ
    - ê·¸ëŸ¬ë‚˜ $T_1$ì€ ìµœì¢… ì‹¤í–‰ì—ì„œë§Œ X-lockì´ í•„ìš”
  - $T_1$ì´ ë¨¼ì € S-lockì„ íšë“í•˜ê³  ë‚˜ì¤‘ì— Lockì„ X-lockìœ¼ë¡œ ë³€ê²½í•œë‹¤ë©´, $T_1$ê³¼ $T_2$ê°€ $a_1$ê³¼ $a_2$ì— ë™ì‹œì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë” ë†’ì€ ë™ì‹œì„±ì„ ì–»ì„ ìˆ˜ ìˆìŒ
  - Lock Upgrade: S-lockì„ X-lockìœ¼ë¡œ ë³€í™˜
  - Lock Downgrade: X-lockì„ S-lockìœ¼ë¡œ ë³€í™˜
- Lock Conversionì„ í¬í•¨í•œ Two-Phase Locking Protocol:
  - Growing Phase
    - ì•„ì´í…œì— ëŒ€í•œ S-lock íšë“
    - ì•„ì´í…œì— ëŒ€í•œ X-lock íšë“
    - S-lockì„ X-lockìœ¼ë¡œ ë³€í™˜ (Upgrade)
  - Shrinking Phase
    - S-lock í•´ì œ
    - X-lock í•´ì œ
    - X-lockì„ S-lockìœ¼ë¡œ ë³€í™˜ (Downgrade)
- ì´ Protocolì€ Serializabilityë¥¼ ë³´ì¥
- Strict Two-Phase Locking ë° Rigorous Two-Phase Locking (Lock Conversion í¬í•¨)ì€ ìƒìš© Database ì‹œìŠ¤í…œì—ì„œ ê´‘ë²”ìœ„í•˜ê²Œ ì‚¬ìš©ë˜ë©°, ë‹¨ìˆœíˆ Two-Phase Lockingìœ¼ë¡œ ì§€ì¹­ë˜ê¸°ë„ í•¨

## Automatic Acquisition of Locks
- Transaction $T_i$ëŠ” ëª…ì‹œì ì¸ Locking í˜¸ì¶œ ì—†ì´ í‘œì¤€ read/write ëª…ë ¹ì„ ì‹¤í–‰
- Operation `read(D)` ì²˜ë¦¬ ë°©ì‹:
```
if Ti has a lock on D then read(D);
else begin
    if necessary wait until no other transaction has a X-lock on D;
    grant Ti a S-lock on D;
    read(D);
end
```
- Operation `write(D)` ì²˜ë¦¬ ë°©ì‹:
```
if Ti has a X-lock on D then write(D);
else begin
    if necessary wait until no other transaction has any lock on D;
    if Ti has a S-lock on D then
        upgrade lock on D to X-lock;
    else grant Ti a X-lock on D;
    write(D);
end
```
- ëª¨ë“  Lockì€ Commit ë˜ëŠ” Abort í›„ì— í•´ì œ (Rigorous 2PL ì‚¬ìš©)

## Implementation of Locking
- Lock ManagerëŠ” ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ë¡œ êµ¬í˜„ë  ìˆ˜ ìˆìŒ
- Transactionì€ Lock ë° Unlock ìš”ì²­ì„ Lock Managerì—ê²Œ ë©”ì‹œì§€ë¡œ ë³´ëƒ„
- Lock ManagerëŠ” Lock Grant ë©”ì‹œì§€(ë˜ëŠ” Deadlockì˜ ê²½ìš° transactionì—ê²Œ Rollbackì„ ìš”ì²­í•˜ëŠ” ë©”ì‹œì§€)ë¥¼ ë³´ë‚´ Lock ìš”ì²­ì— ì‘ë‹µ
- ìš”ì²­í•˜ëŠ” transactionì€ ìš”ì²­ì— ì‘ë‹µí•  ë•Œê¹Œì§€ ëŒ€ê¸°
- Lock Table
  - Lock Managerê°€ ê´€ë¦¬í•˜ëŠ” ì¸ë©”ëª¨ë¦¬ ìë£Œêµ¬ì¡°
  - ìŠ¹ì¸ëœ Lockê³¼ ë³´ë¥˜ ì¤‘ì¸ ìš”ì²­ì„ ê¸°ë¡
  - ì¼ë°˜ì ìœ¼ë¡œ Lockì´ ê±¸ë¦° Data ì•„ì´í…œì˜ ì´ë¦„ì„ Indexë¡œ í•˜ëŠ” Hash Tableë¡œ êµ¬í˜„
  - ê° Hashedëœ Data ì•„ì´í…œì— ëŒ€í•´, ìš”ì²­ì´ ë„ì°©í•œ ìˆœì„œëŒ€ë¡œ ê° ìš”ì²­ì— ëŒ€í•œ Recordì˜ ì—°ê²° ë¦¬ìŠ¤íŠ¸ê°€ ì¡´ì¬
  - Collision í•´ê²°ì„ ìœ„í•´ Chaining ì‚¬ìš©

## Lock Table
- ì—°ê²° ë¦¬ìŠ¤íŠ¸ì˜ ê° Recordì—ëŠ” ë‹¤ìŒì´ í¬í•¨ë¨
  - ìš”ì²­ì„ ë³´ë‚¸ transaction
  - ìš”ì²­í•œ Lock ëª¨ë“œ
  - í˜„ì¬ ìš”ì²­ì´ ìŠ¹ì¸ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
- ìƒˆë¡œìš´ Lock ìš”ì²­ ë©”ì‹œì§€ ë„ì°© ì‹œ
  - Data ì•„ì´í…œì— ëŒ€í•œ ì—°ê²° ë¦¬ìŠ¤íŠ¸ ëì— Record ì¶”ê°€ (ë¹„ì–´ ìˆìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ ìƒì„±)
  - ì´ì „ì˜ ëª¨ë“  Lockê³¼ Compatibleí•˜ë©´ ìŠ¹ì¸
- Unlock ë©”ì‹œì§€ ë„ì°© ì‹œ
  - ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ Record ì‚­ì œ
  - ë’¤ë”°ë¥´ëŠ” Record (ìˆëŠ” ê²½ìš°)ë¥¼ ê²€ì‚¬í•˜ì—¬ ì´ì œ ìŠ¹ì¸ë  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
- Transactionì´ Abortí•˜ë©´, transactionì˜ ëŒ€ê¸° ì¤‘ì´ê±°ë‚˜ ìŠ¹ì¸ëœ ëª¨ë“  ìš”ì²­ì´ ì‚­ì œë¨
  - Lock ManagerëŠ” ì´ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ êµ¬í˜„í•˜ê¸° ìœ„í•´ ê° transactionì´ ë³´ìœ í•œ Lockì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŒ
![alt text](image-11.png)

## ğŸŒ³ (Optional) Graph-based Protocols
- ì¶”ê°€ ì •ë³´ê°€ ìˆë‹¤ë©´ Conflict Serializabilityë¥¼ ë³´ì¥í•˜ëŠ” Two-Phase Locking ì´ì™¸ì˜ ë‹¤ë¥¸ Locking Protocolì„ ê³ ì•ˆí•  ìˆ˜ ìˆìŒ
- ê°„ë‹¨í•œ ì¶”ê°€ ì •ë³´: Database ì•„ì´í…œì— ì ‘ê·¼í•˜ëŠ” ìˆœì„œ
  - ëª¨ë“  Data ì•„ì´í…œì˜ ì§‘í•© D} = \{d_{1}, d_{2}, \dots, d_{h}\ì— ë¶€ë¶„ ìˆœì„œ ($\to$)ë¥¼ ë¶€ê³¼
  - $d_{i} \to d_{jì´ë©´, $d_{iì™€ $d_{j ëª¨ë‘ì— ì ‘ê·¼í•˜ëŠ” ëª¨ë“  transactionì€ $d_{jë³´ë‹¤ $d_{iì— ë¨¼ì € ì ‘ê·¼í•´ì•¼ í•¨
  - ì´ëŸ¬í•œ ë¶€ë¶„ ìˆœì„œëŠ” Dataì˜ ë…¼ë¦¬ì  ë˜ëŠ” ë¬¼ë¦¬ì  ì¡°ì§ì˜ ê²°ê³¼ì¼ ìˆ˜ë„ ìˆê³ , ì˜¤ë¡œì§€ Concurrency Control ëª©ì ìœ¼ë¡œë§Œ ë¶€ê³¼ë  ìˆ˜ë„ ìˆìŒ
  - ì§‘í•© DëŠ” ì´ì œ Directed Acyclic Graph(Database Graph)ë¡œ ë³¼ ìˆ˜ ìˆìŒ
- Tree Protocol: X-lockë§Œ ì‚¬ìš©í•˜ë„ë¡ ì œí•œëœ ê°„ë‹¨í•œ Graph-based Protocol

-   ê° transaction $T_i$ëŠ” Data ì•„ì´í…œì„ ìµœëŒ€ í•œ ë²ˆ Lockí•  ìˆ˜ ìˆìœ¼ë©°, ë‹¤ìŒ ê·œì¹™ì„ ì¤€ìˆ˜í•´ì•¼ í•¨
  -   $T_i$ì˜ ì²« ë²ˆì§¸ Lockì€ ëª¨ë“  Data ì•„ì´í…œì— ê±¸ë¦´ ìˆ˜ ìˆìŒ
  -   ê·¸ í›„, Data ì•„ì´í…œ QëŠ” Qì˜ Parentê°€ í˜„ì¬ $T_i$ì— ì˜í•´ Lockëœ ê²½ìš°ì—ë§Œ $T_i$ì— ì˜í•´ Lockë  ìˆ˜ ìˆìŒ
  -   Data ì•„ì´í…œì€ ì–¸ì œë“ ì§€ Unlockë  ìˆ˜ ìˆìŒ
  -   $T_i$ì— ì˜í•´ Lockë˜ê³  Unlockëœ Data ì•„ì´í…œì€ ê·¸ í›„ì— $T_i$ì— ì˜í•´ ë‹¤ì‹œ Lockë  ìˆ˜ ì—†ìŒ

## ğŸŒ² (Optional) Graph-based Protocols (Cont.)
- Tree Protocolì€ Conflict Serializabilityì™€ Deadlockìœ¼ë¡œë¶€í„°ì˜ ììœ ë¥¼ ë³´ì¥
- Tree Protocolì—ì„œëŠ” 2PLë³´ë‹¤ Unlockì´ ë” ì¼ì° ë°œìƒí•  ìˆ˜ ìˆìŒ
  - ëŒ€ê¸° ì‹œê°„ ë‹¨ì¶• ë° ë™ì‹œì„± ì¦ê°€
  - Protocolì€ Deadlock-free: Rollbackì´ í•„ìš” ì—†ìŒ
- ë‹¨ì 
  - Recoverability ë˜ëŠ” Cascade Freedomì„ ë³´ì¥í•˜ì§€ ì•ŠìŒ
    - Recoverability ë³´ì¥ì„ ìœ„í•´ Commit Dependency ë„ì… í•„ìš”
    - $T_i$ê°€ Uncommitted Data ì•„ì´í…œ Që¥¼ ì½ì„ ë•Œ, Që¥¼ ë§ˆì§€ë§‰ìœ¼ë¡œ Writeí•œ Uncommitted transactionì— ëŒ€í•œ $T_i$ì˜ Commit Dependencyë¥¼ ê¸°ë¡
    - $T_i$ëŠ” Commit Dependencyë¥¼ ê°€ì§„ ëª¨ë“  transactionì´ Commitë  ë•Œê¹Œì§€ Commitì´ í—ˆìš©ë˜ì§€ ì•ŠìŒ: ì´ë“¤ ì¤‘ í•˜ë‚˜ë¼ë„ Abortí•˜ë©´ $T_i$ë„ Abortë˜ì–´ì•¼ í•¨
  - Transactionì€ ì ‘ê·¼í•˜ì§€ ì•ŠëŠ” Data ì•„ì´í…œë„ Lockí•´ì•¼ í•  ìˆ˜ ìˆìŒ
    - ì˜ˆ: Aì™€ Jì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ B, D, H ì•„ì´í…œë„ Lockí•´ì•¼ í•¨
    - Locking ì˜¤ë²„í—¤ë“œ ì¦ê°€ ë° ì¶”ê°€ ëŒ€ê¸° ì‹œê°„
    - ì ì¬ì ì¸ ë™ì‹œì„± ê°ì†Œ
- 2PLì—ì„œëŠ” ë¶ˆê°€ëŠ¥í•œ ìŠ¤ì¼€ì¤„ì´ Tree Protocolì—ì„œ ê°€ëŠ¥í•˜ë©°, ê·¸ ë°˜ëŒ€ë„ ê°€ëŠ¥

## ğŸš« Deadlock Prevention
- Deadlock: transaction ì§‘í•©ì´ ì¡´ì¬í•˜ì—¬, ì§‘í•© ë‚´ì˜ ëª¨ë“  transactionì´ ì§‘í•© ë‚´ì˜ ë‹¤ë¥¸ transactionì„ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” ìƒíƒœ
- Deadlock Prevention Protocols: ì‹œìŠ¤í…œì´ Deadlock ìƒíƒœë¡œ ì§„ì…í•˜ì§€ ì•Šë„ë¡ ë³´ì¥í•˜ëŠ” Protocol. ì¼ë¶€ Prevention ì „ëµ:
  - ê° transactionì´ ì‹¤í–‰ì„ ì‹œì‘í•˜ê¸° ì „ì— ëª¨ë“  Data ì•„ì´í…œì„ Lockí•˜ë„ë¡ ìš”êµ¬ ('Hold-and-wait' ì¡°ê±´ ì œê±°)
  - ëª¨ë“  Data ì•„ì´í…œì— ë¶€ë¶„ ìˆœì„œë¥¼ ë¶€ê³¼í•˜ê³  transactionì´ Data ì•„ì´í…œì„ ì§€ì •ëœ ìˆœì„œë¡œë§Œ Lockí•  ìˆ˜ ìˆë„ë¡ ìš”êµ¬ ('Circular wait' ì¡°ê±´ ì œê±°)

## â±ï¸ Deadlock Prevention (Cont.)
- Transaction Timestamp-based Schemes

  - Wait-Die Scheme (Non-preemptive)
    - Older transactionì€ Younger transactionì´ Data ì•„ì´í…œì„ í•´ì œí•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŒ
    - $\\text{Younger transactionì€ $\\text{Older transactionì„ ì ˆëŒ€ ê¸°ë‹¤ë¦¬ì§€ ì•Šìœ¼ë©°, ëŒ€ì‹  Rollbackë¨
  - Wound-Wait Scheme (Preemptive)
    - Older transactionì€ ê¸°ë‹¤ë¦¬ëŠ” ëŒ€ì‹  $\\text{Younger transactionì„ Wound(Rollback ê°•ì œ)
    - $\\text{Younger transactionì€ $\\text{Older transactionì„ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŒ
  - ë‘ Scheme ëª¨ë‘ì—ì„œ,
    - Rollbackëœ transactionì€ ì›ë˜ Timestampë¡œ ë‹¤ì‹œ ì‹œì‘ë˜ì–´ Starvationì„ ë°©ì§€
    - ë¶ˆí•„ìš”í•œ Rollbackì´ ë°œìƒí•  ìˆ˜ ìˆìŒ
- Lock Timeout-based Schemes (Deadlock Detection & Recoveryì™€ ìœ ì‚¬)

  - Transactionì€ Lockì„ ìœ„í•´ ì§€ì •ëœ ì‹œê°„ ë™ì•ˆë§Œ ëŒ€ê¸°
  - ê·¸ í›„ ëŒ€ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ë©´ transactionì´ Rollbackë¨
  - Deadlockì´ ë°œìƒí•˜ë©´ Timeoutìœ¼ë¡œ í•´ê²°ë˜ë„ë¡ ë³´ì¥
  - êµ¬í˜„ì´ ê°„ë‹¨í•˜ì§€ë§Œ, Deadlockì´ ì—†ëŠ” ê²½ìš°ì—ë„ transactionì„ ë¶ˆí•„ìš”í•˜ê²Œ Rollbackí•  ìˆ˜ ìˆìŒ
  - ì ì ˆí•œ Timeout ê°„ê²© ê°’ì„ ê²°ì •í•˜ê¸° ì–´ë ¤ì›€
  - Starvation ë˜í•œ ë°œìƒ ê°€ëŠ¥

## ğŸ” Deadlock Detection
- Wait-for Graph: transactionì„ ì •ì ìœ¼ë¡œ í•˜ëŠ” Directed Graph
  - $T_i \to \text{T_jë¡œì˜ Edge: $T_i$ê°€ T_jê°€ Conflicting ëª¨ë“œë¡œ ë³´ìœ í•œ Lockì„ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” ê²½ìš°
  - ì‹œìŠ¤í…œì´ Deadlock ìƒíƒœ $\iff$ Wait-for Graphì— Cycleì´ ìˆìŒ
- ì£¼ê¸°ì ìœ¼ë¡œ Deadlock-Detection Algorithmì„ í˜¸ì¶œí•˜ì—¬ Cycleì„ ì°¾ìŒ
- Deadlockì´ ê°ì§€ë˜ë©´:
  - Deadlock Cycleì„ ê¹¨ê¸° ìœ„í•´ ì¼ë¶€ transactionì´ Rollbackë˜ì–´ì•¼ í•¨ (Victim)
  - Victimìœ¼ë¡œ ìµœì†Œ ë¹„ìš©ì„ ì´ˆë˜í•˜ëŠ” transactionì„ ì„ íƒ
  - Rollback: transactionì„ ì–´ë””ê¹Œì§€ Rollbackí• ì§€ ê²°ì •
    - Total Rollback: transactionì„ Abortí•˜ê³  ë‹¤ì‹œ ì‹œì‘
    - Partial Rollback: Cycle ë‚´ì˜ ë‹¤ë¥¸ transactionì´ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” Lockì„ í•´ì œí•˜ëŠ” ë° í•„ìš”í•œ ë§Œí¼ë§Œ Victim transactionì„ Rollback
  - Starvation ê°€ëŠ¥ì„± $\to$ í•´ê²°ì±…: ê°€ì¥ ì˜¤ë˜ëœ transactionì€ Victimìœ¼ë¡œ ì„ íƒí•˜ì§€ ì•ŠìŒ

## ğŸ“ Multiple Granularity
- ì§€ê¸ˆê¹Œì§€ ê°œë³„ Data ì•„ì´í…œì„ Locking Unitìœ¼ë¡œ ì‚¬ìš©
- ë•Œë¡œëŠ” ì—¬ëŸ¬ Data ì•„ì´í…œì„ ê·¸ë£¹í™”í•˜ì—¬ í•˜ë‚˜ì˜ ê°œë³„ Locking Unitìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ìœ ë¦¬
  - ì˜ˆ: ì „ì²´ Relationì„ ìŠ¤ìº”í•  ë•Œ, Tuple-level Lockì„ ë°œí–‰í•˜ëŠ” ëŒ€ì‹  ì „ì²´ Relationì„ Lockí•˜ëŠ” ë‹¨ì¼ Lock ìš”ì²­ì„ ë°œí–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
- ì‹œìŠ¤í…œì´ ë‹¤ì¤‘ ìˆ˜ì¤€ì˜ Granularityë¥¼ ì •ì˜í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì´ í•„ìš”
  - Data ì•„ì´í…œì´ ë‹¤ì–‘í•œ í¬ê¸°ë¥¼ ê°–ë„ë¡ í—ˆìš©í•˜ê³ , ì‘ì€ Granularityê°€ ë” í° Granularity ë‚´ì— Nestë˜ëŠ” ê³„ì¸µ êµ¬ì¡°ë¥¼ ì •ì˜
  - Tree í˜•íƒœë¡œ ê·¸ë˜í”½ì ìœ¼ë¡œ í‘œí˜„ ê°€ëŠ¥
- Transactionì´ Treeì˜ ë…¸ë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ Lockí•˜ë©´, í•´ë‹¹ ë…¸ë“œì˜ ëª¨ë“  Descendantë¥¼ ê°™ì€ ëª¨ë“œë¡œ ì•”ë¬µì ìœ¼ë¡œ Lock
- Locking Granularity(Lockingì´ ìˆ˜í–‰ë˜ëŠ” Treeì˜ ìˆ˜ì¤€):
  - Fine Granularity (Treeì˜ í•˜ìœ„): ë†’ì€ ë™ì‹œì„±, ë†’ì€ Locking ì˜¤ë²„í—¤ë“œ
  - Coarse Granularity (Treeì˜ ìƒìœ„): ë‚®ì€ Locking ì˜¤ë²„í—¤ë“œ, ë‚®ì€ ë™ì‹œì„±

## ğŸ“Š Example of Granularity Hierarchy
- ê°€ì¥ ê±°ì¹œ(ìƒìœ„) ìˆ˜ì¤€ë¶€í„° ì‹œì‘í•˜ëŠ” ìˆ˜ì¤€:
  - Database (DB) $\to$ Area (A_1}, \text{A_2})$ $\to$ File (F_a}, \text{F_b}, \text{F_c})$ $\to$ Record
- ë¬¸ì œ: $T_1$ì´ F_cì— X-lockì„ ë³´ìœ í•˜ê³  ìˆë‹¤ê³  ê°€ì •. F_cì— ì†í•˜ëŠ” ëª¨ë“  Recordì— X-lockì„ ì•”ë¬µì ìœ¼ë¡œ ë³´ìœ 
  - Case 1: $T_2$ê°€ r_c1ì— ëŒ€í•œ Lock ìš”ì²­ì„ ë°œí–‰ (ëª…ì‹œì ìœ¼ë¡œ Lockë˜ì§€ ì•ŠìŒ). $T_2$ê°€ r_c1ì„ Lockí•  ìˆ˜ ìˆëŠ”ì§€ ì–´ë–»ê²Œ ê²°ì •?
    - Rootì—ì„œ r_c1ê¹Œì§€ Treeë¥¼ Traverseí•´ì•¼ í•˜ë©°, í•´ë‹¹ ê²½ë¡œì˜ ì–´ë–¤ ë…¸ë“œë¼ë„ Incompatible ëª¨ë“œë¡œ Lockë˜ì–´ ìˆìœ¼ë©´ $T_2$ëŠ” ëŒ€ê¸°í•´ì•¼ í•¨
  - Case 2: $T_3$ê°€ ì „ì²´ DBì— ëŒ€í•œ Lock ìš”ì²­ì„ ë°œí–‰. ì´ëŠ” ìŠ¹ì¸ë˜ì–´ì„œëŠ” ì•ˆ ë¨. ì–´ë–»ê²Œ ê²°ì •?
    - Incompatible Lockì´ ìˆëŠ”ì§€ ì „ì²´ Treeë¥¼ Traverseí•˜ì—¬ í™•ì¸í•´ì•¼ í•¨
- í•´ê²°ì±…: Intention Lock ëª¨ë“œ

## ğŸ”‘ Intention Lock Modes
- S ë° X Lock ëª¨ë“œ ì™¸ì—, Multiple Granularityë¥¼ ìœ„í•œ ì„¸ ê°€ì§€ ì¶”ê°€ Lock ëª¨ë“œ(Intention Lock Modes)
  - intention-shared (IS): Treeì˜ í•˜ìœ„ ìˆ˜ì¤€ì—ì„œ ëª…ì‹œì  Lockingì´ Shared ëª¨ë“œ Lockìœ¼ë¡œë§Œ ìˆ˜í–‰ë¨ì„ ë‚˜íƒ€ëƒ„
  - intention-exclusive (IX): Treeì˜ í•˜ìœ„ ìˆ˜ì¤€ì—ì„œ ëª…ì‹œì  Lockingì´ Exclusive ëª¨ë“œ ë˜ëŠ” Shared ëª¨ë“œ Lockìœ¼ë¡œ ìˆ˜í–‰ë¨ì„ ë‚˜íƒ€ëƒ„
  - shared and intention-exclusive (SIX): í•´ë‹¹ ë…¸ë“œë¥¼ Rootë¡œ í•˜ëŠ” Subtreeê°€ Shared ëª¨ë“œë¡œ ëª…ì‹œì ìœ¼ë¡œ Lockë˜ì–´ ìˆìœ¼ë©°, í•˜ìœ„ ìˆ˜ì¤€ì—ì„œ Exclusive ëª¨ë“œ Lockìœ¼ë¡œ ëª…ì‹œì  Lockingì´ ìˆ˜í–‰ë˜ê³  ìˆìŒì„ ë‚˜íƒ€ëƒ„
- ë…¸ë“œê°€ ëª…ì‹œì ìœ¼ë¡œ Lockë˜ê¸° ì „ì— í•´ë‹¹ ë…¸ë“œì˜ ëª¨ë“  Ancestorì— Intention Lockì´ ì„¤ì •ë¨
  - Ancestor ë…¸ë“œë¥¼ S ë˜ëŠ” X ëª¨ë“œë¡œ Lockí•  ë•Œ ëª¨ë“  Descendant ë…¸ë“œë¥¼ í™•ì¸í•  í•„ìš” ì—†ì´ í—ˆìš©
- ëª¨ë“  Lock ëª¨ë“œì— ëŒ€í•œ Compatibility Matrix

| | IS | IX | S | SIX | X |
| - | - | - | - | - | - |
| IS | Yes | Yes | Yes | Yes | No |
| IX | Yes | Yes | No | No | No |
| S | Yes | No | Yes | No | No |
| SIX | Yes | No | No | No | No |
| X | No | No | No | No | No |

## ğŸ“œ Multiple Granularity Locking Protocol
- Transaction $T_i$ëŠ” ë‹¤ìŒ ê·œì¹™ì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ Që¥¼ Lockí•  ìˆ˜ ìˆìŒ

    1. Lock Compatibility Matrixë¥¼ ì¤€ìˆ˜í•´ì•¼ í•¨
    2. Treeì˜ Rootê°€ ê°€ì¥ ë¨¼ì € Lockë˜ì–´ì•¼ í•˜ë©°, ì–´ë–¤ ëª¨ë“œë¡œë“  Lockë  ìˆ˜ ìˆìŒ
    3.  ë…¸ë“œ QëŠ” $T_i$ì˜ Parentê°€ í˜„ì¬ IX ë˜ëŠ” IS ëª¨ë“œë¡œ Lockëœ ê²½ìš°ì—ë§Œ S ë˜ëŠ” IS ëª¨ë“œë¡œ Lockë  ìˆ˜ ìˆìŒ
    4.  ë…¸ë“œ QëŠ” $T_i$ì˜ Parentê°€ í˜„ì¬ IX ë˜ëŠ” SIX ëª¨ë“œë¡œ Lockëœ ê²½ìš°ì—ë§Œ X, SIX, ë˜ëŠ” IX ëª¨ë“œë¡œ Lockë  ìˆ˜ ìˆìŒ
    5.  $T_i$ëŠ” ì´ì „ì— ì–´ë– í•œ ë…¸ë“œë„ Unlockí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë…¸ë“œë¥¼ Lockí•  ìˆ˜ ìˆìŒ (ì¦‰, $T_i$ëŠ” Two-Phase)
    6.  $T_i$ëŠ” Qì˜ ìì‹ ì¤‘ $T_i$ì— ì˜í•´ í˜„ì¬ Lockëœ ê²ƒì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ë…¸ë“œ Që¥¼ Unlockí•  ìˆ˜ ìˆìŒ
- Lockì€ Rootì—ì„œ Leaf ìˆœì„œë¡œ íšë“ë˜ëŠ” ë°˜ë©´, Leafì—ì„œ Root ìˆœì„œë¡œ í•´ì œë¨ì„ ê´€ì°°
- Lock Granularity Escalation: íŠ¹ì • ìˆ˜ì¤€ì— Lockì´ ë„ˆë¬´ ë§ì€ ê²½ìš°, ë” ë†’ì€ Granularity S ë˜ëŠ” X Lockìœ¼ë¡œ ì „í™˜

## â• Insert/Delete Operations
- ì§€ê¸ˆê¹Œì§€ Read ë° Write Operationì— êµ­í•œí•˜ì—¬ ë…¼ì˜
- ì¼ë¶€ transactionì€ ìƒˆë¡œìš´ Data ì•„ì´í…œì„ ìƒì„± (Insert)í•˜ê±°ë‚˜ ê¸°ì¡´ Data ì•„ì´í…œì„ ì œê±° (Delete)
- Insert/Delete Operationì— ëŒ€í•œ Locking ê·œì¹™:
  - Read/Write ì¶©ëŒê³¼ Deleteë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì•„ì´í…œì´ Deleteë˜ê¸° ì „ì— X-lockì„ íšë“í•´ì•¼ í•¨
  - Transactionì´ Databaseì— ìƒˆë¡œìš´ Tupleì„ Insertí•  ë•Œ, í•´ë‹¹ Tupleì— ëŒ€í•œ X-lockì´ ìë™ìœ¼ë¡œ ë¶€ì—¬ë¨ $\to$ Tupleì„ Insertí•˜ëŠ” transactionì´ Commitë  ë•Œê¹Œì§€ Insertëœ Tupleì€ ë‹¤ë¥¸ transactionì´ ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ


## ğŸ•°ï¸ Timestamp-based Protocols

## ğŸ·ï¸ Timestamp-based Protocols
- ê° transaction $T_i$ëŠ” ì‹œìŠ¤í…œì— ì§„ì…í•  ë•Œ Timestamp TS}(T_i)$ê°€ ë¶€ì—¬ë¨
- ê° transactionì€ ê³ ìœ í•œ Timestampë¥¼ ê°€ì§
- Newer transactionì€ Earlier transactionë³´ë‹¤ Timestampê°€ ì—„ê²©í•˜ê²Œ í¼
- TimestampëŠ” ì‹œìŠ¤í…œ í´ëŸ­ ë˜ëŠ” ë…¼ë¦¬ì  Counterì¼ ìˆ˜ ìˆìŒ
- Timestamp-based Protocolsì€ transactionì˜ Timestampê°€ Serializability Orderë¥¼ ê²°ì •í•˜ë„ë¡ ë™ì‹œ ì‹¤í–‰ì„ ê´€ë¦¬
  - TS}(T_i) < \text{TS}(\text{T_j})$ì´ë©´, ì‹œìŠ¤í…œì€ ìƒì„±ëœ ìŠ¤ì¼€ì¤„ì´ $T_i$ê°€ T_jë³´ë‹¤ ë¨¼ì € ë‚˜íƒ€ë‚˜ëŠ” ì§ë ¬ ìŠ¤ì¼€ì¤„ê³¼ ë™ë“±í•˜ë„ë¡ ë³´ì¥í•´ì•¼ í•¨
- êµ¬í˜„ì„ ìœ„í•´ ê° Data ì•„ì´í…œ Qì— ë‘ ê°œì˜ Timestampë¥¼ ì—°ê²°
  - W-timestamp}(\text{Q})$: write}(\text{Q})$ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰í•œ transaction ì¤‘ ê°€ì¥ í° Timestamp
  - R-timestamp}(\text{Q})$: read}(\text{Q})$ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰í•œ transaction ì¤‘ ê°€ì¥ í° Timestamp
  - ì´ëŸ¬í•œ TimestampëŠ” ìƒˆë¡œìš´ read}(\text{Q})$ ë˜ëŠ” write}(\text{Q})$ Instructionì´ ì‹¤í–‰ë  ë•Œë§ˆë‹¤ ì—…ë°ì´íŠ¸ë¨
- Timestampë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ëª‡ ê°€ì§€ ëŒ€ì•ˆì ì¸ Protocol ì¡´ì¬

## â¡ï¸ Timestamp-Ordering Protocol
- Timestamp-Ordering (TSO) Protocol
- Read ë° Write Operationì— ê·œì¹™ì„ ë¶€ê³¼í•˜ì—¬ ë‹¤ìŒì„ ë³´ì¥

  - ëª¨ë“  Conflicting Operationì€ Timestamp Orderë¡œ ì‹¤í–‰
  - Out of Order Operationì€ transaction Rollback ë° ìƒˆë¡œìš´ TSë¡œ ì¬ì‹œì‘ì„ ìœ ë°œ
- Transaction $T_i$ê°€ read}(\text{Q})$ë¥¼ ë°œí–‰í•œë‹¤ê³  ê°€ì •

    1. TS}(T_i) < \text{W-timestamp}(\text{Q})$ì´ë©´, $T_i$ëŠ” ë‚˜ì¤‘ transactionì— ì˜í•´ ì´ë¯¸ Overwriteëœ Qì˜ ê°’ì„ ì½ìœ¼ë ¤ê³  í•¨
    - ë”°ë¼ì„œ Read Operationì€ ê±°ë¶€ë˜ê³  $T_i$ëŠ” Rollbackë¨
    2. TS}(T_i) \ge \text{W-timestamp}(\text{Q})$ì´ë©´, Read Operationì€ ì‹¤í–‰ë˜ê³  R-timestamp}(\text{Q})$ëŠ” max}(\text{R-timestamp}(\text{Q}), \text{TS}(T_i))$ë¡œ ì„¤ì •ë¨
- Transaction $T_i$ê°€ write}(\text{Q})$ë¥¼ ë°œí–‰í•œë‹¤ê³  ê°€ì •

    1. TS}(T_i) < \text{R-timestamp}(\text{Q})$ì´ë©´, $T_i$ê°€ ìƒì„±í•˜ëŠ” Qì˜ ê°’ì´ ì´ì „ì— ë‚˜ì¤‘ transactionì— ì˜í•´ í•„ìš”í–ˆìŒ (ì¦‰, ê·¸ ê°’ì€ ê²°ì½” ìƒì„±ë˜ì§€ ì•Šì„ ê²ƒì„)
    - ë”°ë¼ì„œ Write Operationì€ ê±°ë¶€ë˜ê³  $T_i$ëŠ” Rollbackë¨
    2. TS}(T_i) < \text{W-timestamp}(\text{Q})$ì´ë©´, $T_i$ëŠ” Qì˜ Obsolete Valueë¥¼ Writeí•˜ë ¤ê³  í•¨
    - ë”°ë¼ì„œ ì´ Write Operationì€ ê±°ë¶€ë˜ê³  $T_i$ëŠ” Rollbackë¨
    3.  ê·¸ë ‡ì§€ ì•Šìœ¼ë©´, Write Operationì€ ì‹¤í–‰ë˜ê³  W-timestamp}(\text{Q})$ëŠ” TS}(T_i)$ë¡œ ì„¤ì •ë¨

## ğŸ“ˆ Example of Schedule Under TSO
- ì´ ìŠ¤ì¼€ì¤„ì´ TSO í•˜ì—ì„œ ìœ íš¨í•œê°€?

  - ì´ˆê¸° ê°€ì •: R-TS}(\text{A}) = \text{W-TS}(\text{A}) = 0$, R-TS}(\text{B}) = \text{W-TS}(\text{B}) = 0$
  - TS}(\text{T_25}) = 25$, TS}(\text{T_26}) = 26$ ê°€ì •

    | Time | $T_2$5 | $T_2$6 | R-TS}(\text{A})$ | W-TS}(\text{A})$ | R-TS}(\text{B})$ | W-TS}(\text{B})$ |
    | - | - | - | - | - | - | - |
    | $1$ | read}(\text{A})$ | | $25$ | $0$ | $0$ | $0$ |
    | $2$ | read}(\text{B})$ | | $25$ | $0$ | $25$ | $0$ |
    | $3$ | | read}(\text{A})$ | $26$ | $0$ | $25$ | $0$ |
    | $4$ | | read}(\text{B})$ | $26$ | $0$ | $26$ | $0$ |
    | $5$ | write}(\text{A})$ | | $26$ | $25$ | $26$ | $0$ |
    | $6$ | write}(\text{B})$ | | $26$ | $25$ | $26$ | $25$ |
    | $7$ | | write}(\text{A})$ | $26$ | $26$ | $26$ | $25$ |
    | $8$ | | write}(\text{B})$ | $26$ | $26$ | $26$ | $26$ |
- ì´ ìŠ¤ì¼€ì¤„ì€ TSO í•˜ì—ì„œ ìœ íš¨í•¨
- ì´ˆê¸°ì— R-TS}(\text{Q}) = \text{W-TS}(\text{Q}) = 0$ì¸ ì´ ìŠ¤ì¼€ì¤„ì€?

| Time | $T_2$7 (TS}=27$) | $T_2$8 (TS}=28$) | R-TS}(\text{Q})$ | W-TS}(\text{Q})$ |
| - | - | - | - | - |
| $1$ | write}(\text{Q})$ | | $0$ | $27$ |
| $2$ | | read}(\text{Q})$ | $28$ | $27$ |
| $3$ | write}(\text{Q})$ | | Rollback | $27$ |
\-   $T_2$7ì˜ ë‘ ë²ˆì§¸ `write(Q)` ì‹œë„ì—ì„œ TS}(\text{T_27}) = 27 < \text{R-TS}(\text{Q}) = 28$ì´ë¯€ë¡œ, Write Operationì€ ê±°ë¶€ë˜ê³  $T_2$7ì€ Rollbackë¨.

## âœï¸ Thomasâ€™ Write Rule
- Timestamp-Ordering Protocolì˜ ìˆ˜ì •ëœ ë²„ì „ìœ¼ë¡œ, Obsolete Write Operationì€ íŠ¹ì • ìƒí™©ì—ì„œ ë¬´ì‹œë  ìˆ˜ ìˆìŒ
- $T_i$ê°€ Data ì•„ì´í…œ Që¥¼ Writeí•˜ë ¤ê³  í•  ë•Œ, (ê·œì¹™ì˜ ìˆœì„œ ì¤‘ìš”)

    1. TS}(T_i) < \text{R-timestamp}(\text{Q})$ì´ë©´, Write Operationì€ ê±°ë¶€ë˜ê³  $T_i$ëŠ” Rollbackë¨
    2. TS}(T_i) < \text{W-timestamp}(\text{Q})$ì´ë©´, $T_i$ëŠ” Qì˜ Obsolete Valueë¥¼ Writeí•˜ë ¤ê³  í•¨
    - $T_i$ë¥¼ Rollbackí•˜ëŠ” ëŒ€ì‹ , ì´ Write Operationì€ ê·¸ëƒ¥ ë¬´ì‹œë  ìˆ˜ ìˆìŒ
    3.  ê·¸ë ‡ì§€ ì•Šìœ¼ë©´, Write Operationì€ ì‹¤í–‰ë˜ê³  W-timestamp}(\text{Q})$ëŠ” TS}(T_i)$ë¡œ ì„¤ì •ë¨
- ì´ Protocolì˜ ì²« ë²ˆì§¸ì™€ ì„¸ ë²ˆì§¸ ê·œì¹™ì€ Timestamp-Ordering Protocolê³¼ ë™ì¼
- Thomas' Write Ruleì˜ Correctness

  - $T_i$ê°€ ì²« ë²ˆì§¸ ê·œì¹™ì„ í†µê³¼. ë”°ë¼ì„œ TS}(T_i) \ge \text{R-timestamp}(\text{Q})$
  - TS}(T_i) < \text{W-timestamp}(\text{Q})$ì´ë©´, R-timestamp}(\text{Q}) \le \text{TS}(T_i) < \text{W-timestamp}(\text{Q})$
  - ì´ëŠ” Që¥¼ Writeí•œ transactionì´ Që¥¼ ì½ì€ ì ì´ ì—†ìŒì„ ì˜ë¯¸ (Blind Write)
  - Blind WriteëŠ” ì•„ì´í…œì˜ ì´ì „ ê°’ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ $\to$ ì´ì „ WriteëŠ” ì•ˆì „í•˜ê²Œ ë¬´ì‹œë  ìˆ˜ ìˆìŒ
- Thomas' Write Ruleì€ ë” í° ì ì¬ì  ë™ì‹œì„±ì„ í—ˆìš©
- Conflict-Serializableí•˜ì§€ ì•Šì€ ì¼ë¶€ View-Serializable ìŠ¤ì¼€ì¤„ì„ í—ˆìš©

## ğŸš€ Validation-based Protocols (Optimistic Concurrency Control)

## ğŸ¯ Validation-based Protocol
- Concurrency-Control Scheme
  - Code ì‹¤í–‰ ì˜¤ë²„í—¤ë“œë¥¼ ë¶€ê³¼
  - Transaction ì‹¤í–‰ì„ ì§€ì—°ì‹œí‚¬ ìˆ˜ ìˆìŒ
- ëŒ€ë‹¤ìˆ˜ transactionì´ Read-onlyì´ê³  transaction ê°„ì˜ ì¶©ëŒ ë¹„ìœ¨ì´ ë‚®ì€ ê²½ìš°
  - Concurrency-Control ì—†ì´ ì‹¤í–‰ë˜ë”ë¼ë„ ë§ì€ transactionì´ ì‹œìŠ¤í…œì„ ì¼ê´€ëœ ìƒíƒœë¡œ ë‚¨ê¸¸ ê²ƒì„
  - $\to$ ë” ì ì€ ì˜¤ë²„í—¤ë“œë¥¼ ë¶€ê³¼í•˜ëŠ” ëŒ€ì•ˆì ì¸ Concurrency-Control Schemeì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
- Idea: Concurrency Control ì—†ì´ (ë¡œì»¬ ë³€ìˆ˜ì—ì„œ) ì‹¤í–‰í•œ ë‹¤ìŒ, Serializability ìœ„ë°˜ì„ ì¼ìœ¼í‚¤ì§€ ì•Šìœ¼ë©´ DBì— Write (ìœ íš¨ì„± ê²€ì‚¬ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´)
  - WriteëŠ” transaction ì¢…ë£Œ ì‹œì ìœ¼ë¡œ Postpone
  - Transactionì´ Read/Writeí•œ Data ì•„ì´í…œì„ Track
  - Commit ì‹œì ì— ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì—¬ Serialization Orderë¥¼ ë²—ì–´ë‚œ Read/Writeë¥¼ ê°ì§€
- Transactionì´ ìœ íš¨ì„± ê²€ì‚¬ ë™ì•ˆ ëª¨ë“  ê²ƒì´ ì˜ ë  ê²ƒì´ë¼ëŠ” í¬ë§ìœ¼ë¡œ ì™„ì „íˆ ì‹¤í–‰ë˜ë¯€ë¡œ Optimistic Concurrency Control (OCC)ì´ë¼ê³ ë„ í•¨
- Transaction $T_i$ì˜ ì‹¤í–‰ì€ ì„¸ ë‹¨ê³„ë¡œ ìˆ˜í–‰
    1. Read and Execution Phase: $T_i$ ì‹¤í–‰. Data ì•„ì´í…œì„ (ì„ì‹œ) ë¡œì»¬ ë³€ìˆ˜ì— ì½ê³  ì €ì¥. ì‹¤ì œ Database ì—…ë°ì´íŠ¸ ì—†ì´ ë¡œì»¬ ë³€ìˆ˜ì— Write
    2. Validation Phase: $T_i$ëŠ” Serializabilityë¥¼ ìœ„ë°˜í•˜ì§€ ì•Šê³  ë¡œì»¬ ë³€ìˆ˜ë¥¼ Writeí•  ìˆ˜ ìˆëŠ”ì§€ ê²°ì •í•˜ê¸° ìœ„í•œ Validation Testë¥¼ ìˆ˜í–‰. transactionì´ Validation Testì— ì‹¤íŒ¨í•˜ë©´ Abortë¨ (Rollback í•„ìš” ì—†ìŒ).
    3.  Write Phase: $T_i$ê°€ Validateë˜ë©´ ì—…ë°ì´íŠ¸ê°€ Databaseì— ì ìš©ë¨ (Read-only transactionì€ ì´ ë‹¨ê³„ë¥¼ ìƒëµ)
- ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” transactionì˜ ì„¸ ë‹¨ê³„ëŠ” Interleaveë  ìˆ˜ ìˆìŒ
- í•˜ì§€ë§Œ ê° transactionì€ ë°˜ë“œì‹œ ê·¸ ìˆœì„œëŒ€ë¡œ ì„¸ ë‹¨ê³„ë¥¼ ê±°ì³ì•¼ í•¨
- ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ Validation ë° Write ë‹¨ê³„ëŠ” ì›ìì ì´ê³  ì§ë ¬ì ìœ¼ë¡œ í•¨ê»˜ ë°œìƒí•œë‹¤ê³  ê°€ì •
  - ì¦‰, í•œ ë²ˆì— í•˜ë‚˜ì˜ transactionë§Œ Validation/Writeë¥¼ ì‹¤í–‰
- ê° transaction $T_i$ëŠ” 3ê°œì˜ Timestampë¥¼ ê°€ì§

  - StartTS}(T_i)$: $T_i$ê°€ ì‹¤í–‰ì„ ì‹œì‘í•œ ì‹œê°„
  - ValidationTS}(T_i)$: $T_i$ê°€ Validation ë‹¨ê³„ì— ì§„ì…í•œ ì‹œê°„
  - FinishTS}(T_i)$: $T_i$ê°€ Write ë‹¨ê³„ë¥¼ ì™„ë£Œí•œ ì‹œê°„
- ValidationTS}(T_i)$ë¥¼ ì‚¬ìš©í•˜ì—¬ TSOì— ì˜í•´ Serializability Orderë¥¼ ê²°ì •

  - ì¦‰, TS}(T_i) = \text{ValidationTS}(T_i)$
  - TS}(\text{T_j}) < \text{TS}(\text{T_k})$ì´ë©´, ìƒì„±ëœ ëª¨ë“  ìŠ¤ì¼€ì¤„ì€ T_jê°€ T_kë³´ë‹¤ ë¨¼ì € ë‚˜íƒ€ë‚˜ëŠ” ì§ë ¬ ìŠ¤ì¼€ì¤„ê³¼ ë™ë“±í•´ì•¼ í•¨
- Validation TestëŠ” ìœ„ Timestampì™€ Read/Write Setì„ ì‚¬ìš©í•˜ì—¬ Serializability Orderê°€ Validation Timeì— ì˜í•´ ê²°ì •ë˜ë„ë¡ ë³´ì¥

  - Read Set of $T_i$: $T_i$ê°€ Readí•œ Data ì•„ì´í…œì˜ ì§‘í•©
  - Write Set of $T_i$: $T_i$ê°€ Writeí•œ Data ì•„ì´í…œì˜ ì§‘í•©
- Validation-based Protocolì€ ì¶©ëŒ í™•ë¥ ì´ ë‚®ì€ ê²½ìš° Locking/TSOë³´ë‹¤ ë” ë†’ì€ ë™ì‹œì„±ì„ ì œê³µí•˜ëŠ” ê²ƒìœ¼ë¡œ ë°í˜€ì§

## Validation Test
- Transaction $T_i$ì— ëŒ€í•œ Validation TestëŠ” TS}(\text{T_k}) < \text{TS}(T_i)$ì¸ ëª¨ë“  T_kì— ëŒ€í•´ ë‹¤ìŒ ì¡°ê±´ ì¤‘ í•˜ë‚˜ê°€ Holdí•´ì•¼ í•¨ì„ ìš”êµ¬

  - FinishTS}(\text{T_k}) < \text{StartTS}(T_i)$
    - T_kê°€ $T_i$ê°€ ì‹œì‘í•˜ê¸° ì „ì— ì‹¤í–‰ì„ ì™„ë£Œí–ˆìœ¼ë¯€ë¡œ, Serializability OrderëŠ” ì‹¤ì œë¡œ ìœ ì§€ë¨
  - Write Set of T_k $\cap$ Read Set of $T_i = \emptyset$, AND T_kê°€ $T_i$ê°€ Validation ë‹¨ê³„ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— Write ë‹¨ê³„ë¥¼ ì™„ë£Œ (StartTS}(T_i) < \text{FinishTS}(\text{T_k}) < \text{ValidationTS}(T_i)$)
- ìœ„ ì¡°ê±´ ì¤‘ í•˜ë‚˜ê°€ Holdí•˜ë©´ Validationì€ ì„±ê³µí•˜ê³  $T_i$ëŠ” Write ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŒ. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ Validationì€ ì‹¤íŒ¨í•˜ê³  $T_i$ëŠ” Abortë¨
- Justification

  - ì²« ë²ˆì§¸ ì¡°ê±´: transaction ì‹¤í–‰ì´ Concurrentí•˜ì§€ ì•Šì„ ë•Œ ì ìš©
    - Serializability OrderëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ìœ ì§€ë¨
  - ë‘ ë²ˆì§¸ ì¡°ê±´: ì‹¤í–‰ì´ Concurrentí•˜ì§€ë§Œ, $T_i$ëŠ” T_kê°€ Writeí•œ ì–´ë–¤ ì•„ì´í…œë„ Readí•˜ì§€ ì•Šì•˜ê³ , $T_i$ëŠ” T_kì˜ Readì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ì—†ìŒ
    - FinishTS}(\text{T_k}) < \text{ValidationTS}(T_i)$ëŠ” $T_i$ì— ì˜í•œ Writeê°€ ì‹¤ì œë¡œ Databaseì— Writeë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— T_kê°€ $T_i$ì— ì˜í•œ ì–´ë–¤ Writeë„ ë³´ì§€ ì•Šì•˜ìŒì„ ë³´ì¥

## ğŸ“Š Schedule Produced by Validation
- Validationì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ëœ ìŠ¤ì¼€ì¤„ì˜ ì˜ˆ

| Time | $T_1$ | $T_2$ | TS | Read Set | Write Set |
| - | - | - | - | - | - |
| $1$ | read}(\text{A})$ | | | $\{\text{A}\ | $\emptyset$ |
| $2$ | read}(\text{B})$ | | | $\{\text{A}, \text{B}\ | $\emptyset$ |
| $3$ | | read}(\text{B})$ | | $\emptyset$ | $\emptyset$ |
| $4$ | | read}(\text{C})$ | | $\{\text{B}, \text{C}\ | $\emptyset$ |
| $5$ | | compute B}=\text{B}+1$ | | $\{\text{B}, \text{C}\ | $\{\text{B}\ |
| $6$ | | compute A}=\text{A}+1$ | | $\{\text{B}, \text{C}\ | $\{\text{A}, \text{B}\ |
| $7$ | | Validation $T_2$ (TS}=7$) | $7$ | | |
| $8$ | | write}(\text{A})$ | | | |
| $9$ | | write}(\text{B})$ | | | |
| $10$ | compute A}=\text{A}+1$ | | | $\{\text{A}, \text{B}\ | $\{\text{A}\ |
| $11$ | Validation $T_1$ (TS}=11$) | | $11$ | | |
- $T_2$ $(\text{TS}=7) < \text{T_1 $(\text{TS}=11)$ì— ëŒ€í•œ Validation Test
  - FinishTS}(\text{T_2}) = 9$. StartTS}(\text{T_1}) = 1$
  - FinishTS}(\text{T_2}) \nless \text{StartTS}(\text{T_1})$ (ì¦‰, $9 \nless 1$)
  - Write Set of $T_2 = \{\text{A}, \text{B}\
  - Read Set of $T_1 = \{\text{A}, \text{B}\
  - Write Set of $T_2 \cap \text{Read Set of $T_1 = \{\text{A}, \text{B}\} \ne \emptyset$
- Validation Test ì‹¤íŒ¨ $\to$ $T_1$ Abort
- ìœ„ ìŠ¤ì¼€ì¤„ì€ ì§ë ¬ ìŠ¤ì¼€ì¤„ (Validation Timestamp Order)ê³¼ ë™ë“±